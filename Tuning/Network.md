#linux网络排查
##实验目的
>了解网络故障的排查方法，能够判断网络故障所在位置，使用相应的命令进行网络故障排查；

##实验内容
>检查网络设备；
>检查IP地址；
>配置网关和路由；
>检查域名解析；


##实验要求
>能够排查并解决相应的网络故障，记得各种排查所使用到的命令功能；

##准备知识
>网络故障，无非和以下条件有关：
>>硬件（如网卡故障）；
>>IP地址；
>>网关；
>>DNS；
>其他(网络环路)；

##实验步骤

###检查网络设备
>要能连网，网络设备首先必须保证处于工作状态，如果网卡没有开启，则肯定不能上网的，假设我们使用eth0网卡上网，首先检查该网卡是否处于up状态，使用ip命令:	
`ip link ls eth0`

>state必须处于up状态，若处于down状态，尝试手动启动：
`ip link set eth0 up	或	ifconfig eth0 up`

###检查IP地址
>如果网卡已经处于up状态，但仍无法上网，则需要查看网卡是否配置好ip地址：
`ifconfig eth0	`

>如果是通过dhcp方式获取IP地址，然则获取IP失败，可以尝试手动获取IP地址：
`dhclient -v eth0`

>如果无法获取ip，且网卡处于up状态,则可能是链路问题，无法连接DHCP服务器。如果知道DHCP服务器地址，可以ping一下试试，比如DHCP服务器地址为192.168.1.1：
`ping 192.168.1.1`

>如果DHCP禁ping，可以使用：
```
nc -zv 192.168.1.1	67
nc -zv 192.168.1.1	54
```

>>说明：虽然DHCP端口是67，不过通常DHCP和DNS服务器是同一台机器，因此顺便测试53端口：

>如果服务器的IP不是通过DHCP获取的动态IP，而是静态IP，而且知道局域网的IP架构，比如所在网段是192.168.1.0/24，网关是192.168.1.1，可以尝试手动设置IP地址，使用ifconfig配置:
`ifconfig eth0 192.168.1.111/24 gw 192.168.1.1`

###配置网关和路由
>如果网卡的IP已经配置正确（包括子网掩码），仍然不能上网，则需要检查能否ping通网关地址，通常网关地址为网络地址的第一个ip或者最后一个ip，比如若ip为192.168.1.101/24，则网关通常为192.168.1.1或者192.168.1.254，如果不是二者，则需要询问网管了，假设网关地址为192.168.1.1,ping一下是否通：
`ping 192.168.1.1`

>如果ping不通，则可能是交换机问题，如果网关连通性良好，则查看路由表是否正确：
`route -n`	

>其中Genmask为0.0.0.0的是默认路由，检查Gateway是否正确，不正确的话需要重新修改默认网关：
```
route del default eth0	#先删除错误网关
route add default gw 172.16.0.1 dev eth0 #填写正确网关
```

>此时可以ping一下外网ip（指不在同一个局域网的IP），注意这里不要用域名，因为可能DNS还是有问题，比如可以ping电信的DNS服务器IP地址：`114.114.114.114`

>如果不能连通外网，可以使用tracepath命令查看到底是哪不通:
`tracepath 114.114.114.114`


###检查域名解析
>如果能够ping通外网，但仍然不能使用浏览器上网，那可能是域名解析不了了，即DNS服务器配置有错误或不可达，检查下：
`nslookup server`

>此时会输出DNS服务器地址，检查是否正确，若不正确或者不存在，可以临时设置，修改/etc/resolve.conf文件,设置可用的DNS服务器，如果不知道本区的DNS服务器，可以设置通用的8.8.8.8,可以同时设置多个DNS服务器；

>编辑域名解析文件：`vi /etc/resolve.conf`

>设置完成后，试一下能不能解析域名：
`nslookup www.baidu.com`

###总结:
>网络通常是一个反反复复的棘手问题，除了以上提到的经典问题外，其他配置比如代理、防火墙、VPN、认证等，也有可能导致不能正常上网，务必配置正确，本文不再介绍。还有更棘手的比如mtu设置不正确（比如Openstack neutron使用gre隧道，注意设置mtu为1400）、病毒劫持等，遇到此类问题，可以试试tcpdump命令进行抓包分析；
