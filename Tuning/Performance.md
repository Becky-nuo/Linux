#linux性能监控与测试
##实验目的
>了解并掌握linux性能监控与测试的方法，包括每种命令的原理与作用；

##实验内容
>磁盘性能监控与测试；
>内存性能监控与测试；
>COU性能监控与测试；
>TCP连接数监控与测试；
>进程信息

##实验要求
>记住并掌握各种性能监控与测试的命令用法，如磁盘，内存等系统资源的监控与测试；

##准备知识
###磁盘性能
>机器上有很多的数据是存储在磁盘上的，我们读取的很多数据都是要和磁盘交互的，但是磁盘同时又是一个低速设备，很多时候会发生阻塞，所以磁盘I/O的监控很重要。我们使用iostat来诊断磁盘的情况；

###内存性能
>内存使用情况，直接影响到机器的运转状态，所以，对内存性能的监控是非常重要的，可以用free命令查看内存使用情况；

###CPU
>如果CPU使用率过高，机器将处于假死状态，对请求的响应速度大大降低。可以使用mpstat等命令对其监控；

###TCP连接数
>监控TCP连接数，从安全性角度可以在一定程度上，防止非常连接的侵入，可以使用ss,netstat进行连接数监控；

###进程信息
>进程数，一般指是服务的进程数。如果服务的某些进程数异常（如假死），将导致服务异常，可以使用ps/pstree，top，pidstat等进行监控；

##实验步骤
###磁盘性能监控与测试
>命令：`iostat`

>参数说明：
```
tps:设备每秒的传输次数，表示每秒多少个I/O请求；
kB_read/s：每秒从设备读取到的数据量；
kB_wrtn/s：每秒向设备写入的数据量；
kB_read：读取的总数据量；
kB_wrtn：写入的总数据量；
%user：代表用户态进程使用CPU负载；
%nice：代表优先级进程使用的CPU负载；
%system：代表内核态进程使用的CPU负载；
%iowait：代表CPU等待I/O时，CPU的负载；
%steal：代表被偷走的CPU负载情况（在虚拟化技术中会用到）；
%idle：代表空闲的所占用的CPU负载情况；

iostat还有一个常用的参数选项-x，表示扩展的信息；

rrqm/s：每秒这个设备相关的读取请求有多少被Merge(多个I/O合并的操作)了；
wrqm/s：每秒这个设备相关的写入请求有多少被Merge了；
r/s：每秒发送到设备的读请求数；
w/s：每秒发送到设备的写请求数；
rsec/s：每秒读取设备扇区的次数；
wsec/s：每秒写入设备扇区的次数；
avgrq-sz：平均请求扇区的大小；
avgqu-sz：平均请求队列的长度；
await：每一个I/O请求的处理的平均时间(等待时间)；
r_await：每一个读I/O请求的处理的平均时间；
w_await：每一个写I/O请求的处理的平均时间；

svctm：表示平均每次I/O操作的服务时间。如果svctm值和await值很接近，则表示I/O几乎没有等待，如果await的值远高于svctm的值，则表示I/O队列等待太长；

%util：在统计的时间内总共有多少的时间用于处理I/O操作,即被消耗的CPU的百分比。例如统计时间间隔是1s，那么这个设备有0.65s在处理I/O，有0.35s处于空闲。那么这个设备的%util=0.65/1=65%，一般地，如果该参数是100%表示设备已经接近满负荷运行了（当然如果是多磁盘，即使%util是100%，因为磁盘的并发能力，所以磁盘使用未必就到了瓶颈）；
```
###内存性能监控与测试
>命令：`free`

>参数说明：
```
total：总物理内存大小；
used：已经分配的大小；
free：没有被分配的大小；
shared：共享内存的大小，主要用于IPC通信；
buff：用于块设备的缓冲；
cache：用于文件内容缓冲，也就是缓存；
available：可用大小；
swap：交换分区内存大小；

"缓存"就是在内存中划分一块区域，作为进程和硬盘之间的缓冲区，进程将数据写入缓存中，当那些数据需要读取的时候，就直接去"高速路"缓存中读取，而不会去"土路"硬盘中读取，这样大大的加快性能；

这里buffer实际上是存储了我们数据的元数据(包括目录名字，文件大小，文件存储块，修改时间，权限等)，而cache则存放了我们最近读取过的文件；
```
>从应用程序层面看,可用内存=free memory+buffers+cached   另：可通过命令：  ~ cat /proc/meminfo 查看内存的所有详细信息；

###CPU性能监控与测试
>命令：`mpstat`
>>mpstat能够实时的输出CPU的信息；

>参数说明：
```
%user：在internal时间段里，用户态的CPU时间(%)；
%nice：在internal时间段里，nice值为负进程的CPU时间(%)；   
%sys：在internal时间段里，内核时间(%)；       
%iowait：在internal时间段里，硬盘IO等待时间(%)； 
%irq：在internal时间段里，硬中断时间(%)；     
%soft：在internal时间段里，软中断时间(%)；    
%idle：在internal时间段里，CPU除去等待磁盘IO操作外的因为任何原因而空闲的时间闲置时间(%)； 
```
###TCP连接数监控与测试
>命令：`ss，netstat`

>>ss是Socket  Statistics的缩写，顾名思义ss命令就是用来获取sockets的信息，他可以显示和netstat类似的内容，但是他比netstat更快更高效，而且显示更为详细的有关TCP连接信息。当我们的sockets连接数非常大的时候，无论是我们使用netstat命令还是在内核中查看连接数cat /proc/net/tcp的时候都会很缓慢；

>>ss快速的原因就是他利用了TCP协议中的tcp_diag,tcp_diag是一个用于分析和统计的模块，他可以获取到Linux内核中的第一手信息，这个确保了ss的高效性；

>参数说明:
```
netstat:
-t：表示TCP的连接；
-u：表示UDP的连接；
-n：表示以数字的形式显示信息；
-p：表示显示监听的端口号；
```
>例：
>>查看系统中守护进程的监听状态:`netstat -at`

>>查看当前服务器的网络连接统计：`ss -s`


###进程信息
>命令：`ps，pidstat`
>例：
>>查看ssh具体进程:`pidstat`
>>使用pidstat来查看每一个进程的pid的状态信息，以及他所占的CPU信息；
>>其他综合显示命令：vmstat，top，sar vmstat top（性能实时刷新，可按Ctrl+c中止命令）；

>>在这个界面下：
```
按m按照内存使用大小排序显示；
按P按照CPU使用大小排序显示； 
按M按照常驻留内存大小排序；
按k表示杀死某个进程；
sar uptime：查看linux系统启动了多长时间（top也可以显示）；
```
